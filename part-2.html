<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Praktyczne zastosowania ESP8266</title>

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/night.css" id="theme">
    <link rel="stylesheet" href="css/custom.css">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section class="title" data-background-image="img/cia-out.jpg" data-background-opacity="0.6">
            <h3 class="title">Praktyczne zastosowania ESP8266</h3>
            <h4>część 2</h4>
            <p>- Maciej Małecki -</p>
            <p>- Marcin Iwanczewski -</p>
        </section>

        <section>
            <img src="img/smart-home.png" alt="Smart home" width="1000">
        </section>

        <section>
            <h3>Architektura</h3>
            <img src="img/architecture.png" alt="Architektura">
        </section>

        <section>
            <h3>TasmoAdmin</h3>
            <img src="img/tasmoadmin-devices.png" width="1000">
            <p><a href="https://github.com/reloxx13/TasmoAdmin">https://github.com/reloxx13/TasmoAdmin</a></p>
        </section>

        <section>
            <h3>TasmoAdmin - skanowanie sieci</h3>
            <img src="img/tasmoadmin-scan.png" width="600">
        </section>

        <section>
            <h3>TasmoAdmin - lista urządzeń</h3>
            <img src="img/tasmoadmin-devices.png" width="800">
        </section>

        <section>
            <div class="r-hstack">
                <div>
                    <img src="img/Home_Assistant_Logo.svg.png" alt="Home Assistant">
                    <p>Home Assistant</p>
                </div>
                <div>
                    <img src="img/rpi3.png" alt="rpi3">
                    <p>Raspberry Pi</p>
                </div>
            </div>
        </section>

        <section>
            <h3>Home assistant</h3>
            <div class="r-hstack">
                <img src="img/hass-dashboard.png" alt="Dashboard">
                <img src="img/hass/integrations-1.png" alt="Inte 1">
                <img src="img/hass/integrations-2.png" alt="Inte 2">
                <img src="img/hass/integrations-3.png" alt="Inte 3">
            </div>
        </section>


        <section>
            <h3>Powiadomienia...</h3>
            <div class="r-hstack">
                <img src="img/hass-notifications.png" alt="Nots">
                <img src="img/hass-notifications-2.png" alt="Nots">
                <img src="img/hass-notifications-3.png" alt="Nots">
            </div>
        </section>

        <section>
            <h3>Najważniejsze dodatki</h3>
            <p>Home Assistant posiada Plugin-Store</p>
            <div class="r-vstack">

            <div class="r-hstack small">
                <img src="img/hass/addon-mqtt.png" alt="">
                <img src="img/hass/addon-influx-db.png" alt="">
                <img src="img/hass/addon-grafana.png" alt="">
            </div>
            <div class="r-hstack small">
                <img src="img/hass/addon-fileeditor.png" alt="">
                <img src="img/hass/addon-chrony.png" alt="Chrony">
                <img src="img/hass/addon-ssh.png" alt="SSH">
            </div>
            </div>
        </section>

        <section>
            <h3>MQ Telemetry Transport (MQTT)</h3>
            <img src="img/mqtt-example.png">
            <aside class="notes">
                <ul>
                    <li>Prosty, lekki protokół transmisji danych</li>
                    <li>Dla urządzeń w środowiskach o niskiej przepustowości (M2M)</li>
                    <li>Standard open OASIS i ISO</li>
                </ul>
            </aside>
        </section>
        <section>
            <h3>MQTT - Quality of Service (QoS)</h3>
            <div class="r-hstack small">
                <div>
                    <span class="other-color-2">QoS 0</span> - at most once
                    <img src="img/mqtt-qos-0.png" width="400">
                </div>
                <div>
                    <span class="other-color-4">QoS 1</span> - at least once
                    <img src="img/mqtt-qos-1.png" width="400">
                </div>
                <div>
                    <span class="other-color-3">QoS 2</span> - exactly once
                    <img src="img/mqtt-qos-2.png" width="400">
                </div>
            </div>
        </section>
        <section>
            <h3>MQTT - Flagi wiadomości (Publish)</h3>
            <table>
                <tbody>
                <tr>
                    <td>
                        <b>Bit 3</b>
                    </td>
                    <td>
                        <b>Bit 2</b>
                    </td>
                    <td>
                        <b>Bit 1</b>
                    </td>
                    <td>
                        <b>Bit 0</b>
                    </td>
                </tr>
                <tr>
                    <td class="other-color">
                        DUP
                    </td>
                    <td class="other-color-2">
                        QoS
                    </td>
                    <td class="other-color-2">
                        QoS
                    </td>
                    <td class="other-color-3">
                        RETAIN
                    </td>
                </tr>
                </tbody>
            </table>
            <aside class="notes">
                RETAIN - msg zostanie mimo braku subscrybentów (w przeciwnym wypadku broker usunie wiadomość)
            </aside>
        </section>

        <section>
            <h3>Tasmota</h3>
            <h3>Overview projektów</h3>
            <ul>
                <li>Łącznik "schodowy++"</li>
                <li>Wentylowana szafa na mopa</li>
                <li><span class="other-color-3">PIR z dowolnym czasem opóźnienia wyłączenia</span></li>
                <li><span class="other-color-3">RF gateway</span></li>
            </ul>
        </section>
        <section>
            <h3>Łącznik "schodowy++" - koncepcja</h3>
            <img src="img/shelly2-4.png">
        </section>

        <section>
            <h3>Łącznik "schodowy++" - realizacja</h3>
            <div class="r-hstack">
                <div>
                    <img src="img/bed-light-01.jpg">
                </div>
                <div>
                    <img src="img/bed-light-02.jpg">
                </div>
            </div>
        </section>

        <section>
            <h3>Wentylowana szafa na mopa</h3>
            <div class="r-hstack">
                <div>
                    <img src="img/vent-locker-01.jpg">
                </div>
                <div>
                    <img src="img/vent-locker-02.jpg">
                </div>
                <div>
                    <img src="img/vent-locker-03.jpg">
                </div>
            </div>
        </section>

        <section>
            <h3>PIR z dowolnym czasem opoźnienia włączenia</h3>
            <img src="img/ESP-PIR-WS2812.png" width="900">
        </section>

        <section>
            <h3>PIR wygląd zewnętrzny</h3>
          <div class="r-hstack">
            <div>
              <img src="img/PIR-real-front.jpg">
            </div>
            <div>
              <img src="img/PIR-real-back.jpg">
            </div>
            <div>
              <img src="img/PIR-real-case.jpg">
            </div>
          </div>
        </section>

        <section>
            <h3>PIR - Konfiguracja w Tasmota</h3>
            <img src="img/PIR-Tasmota-config.png" width="290">
        </section>

        <section>
            <h3>PIR - Opóźnienie w Tasmota</h3>
            <pre><code>Rule1 on Switch1#state=1 do publish bedroom.pir.01/stat/MOTION ON;
RuleTimer1 30 endon on Rules#Timer=1 do publish bedroom.pir.01/stat/MOTION OFF endon
            </code></pre>
        </section>

        <section>
            <h3>PIR - HomeAssistant podstawowa konfiguracja</h3>
            <pre><code>
                switch:
                  - platform: mqtt
                    name: "Bed strip left"
                    state_topic: "bedroom.pir.01/tele/STATE"
                    command_topic: "bedroom.pir.01/cmnd/POWER"
                    availability_topic: "bedroom.pir.01/tele/LWT"
                    payload_on: "ON"
                    payload_off: "OFF"
                    retain: false
                    icon: mdi:led-strip
            </code></pre>
        </section>
        <section>
            <h3>PIR - HomeAssistant Automation (Web UI)</h3>
            <pre><code>Rule1 on Switch1#state=1 do publish bedroom.pir.01/stat/MOTION ON endon
      on switch1#state=0 do publish bedroom.pir.01/stat/MOTION OFF endon</code></pre>
          <img src="img/HA-Automation-pir.png" width="800">
        </section>
      <section>
        <h3>PIR - HomeAssistant Automation (yaml)</h3>
        <pre><code>automation:
    - id: ed99a146147842d48e6479e41f4e6c62
      alias: Turn on left bedstrip when there is movement
      trigger:
        - entity_id: binary_sensor.bedroom_pir_sensor
          platform: state
          to: 'on'
        action:
        - alias: ''
          data:
            entity_id: light.bedroom_left_pir_switch
          service: homeassistant.turn_on

    - id: b92a6c75c2ed4a94a49e758a3db6228f
      alias: Turn off left bedstrip 10 seconds after last movement
      trigger:
      - entity_id: binary_sensor.bedroom_pir_sensor
        for: 0:00:10
        platform: state
        to: 'off'
      action:
      - data:
        entity_id: light.bedroom_left_pir_switch
        service: homeassistant.turn_off
        </code></pre>
      </section>

      <section>
          <h3>Sonoff RF 433 Bridge </h3>
          <img src="img/sonoff-rf-gateway.jpg">
      </section>
      <section>
        <h3>Sonoff RF 433 Bridge - flashowanie</h3>
        <img src="img/sonoff-rf-bridge-pins.jpg" width="600">
      </section>
      <section>
          <h3>Sonoff RF Bridge - Konfiguracja Tasmota</h3>
          <div class="r-hstack">
              <div>
                  <img src="img/tasmota-rf-bridge-config.png">
              </div>
              <div>
                  <img src="img/tasmota-rf-bridge.png">
              </div>
          </div>
      </section>
      <section>
        <h3>Sonoff RF Bridge - Pilot</h3>
        <div class="r-hstack">
          <div>
            <img src="img/sonoff-rf-remote-01.jpg">
          </div>
          <div>
            <img src="img/sonoff-rf-remote-02.jpg">
          </div>
        </div>
      </section>
      <section>
        <h3>Sonoff RF Rule</h3>
        <pre><code>Rule1 on RfReceived#Data do publish rainbow.lr/cmd/rfcode/%value% ON endon</code></pre>
      </section>
      <section>
        <h3>Sonoff RF - HomeAssistant</h3>
        <pre><code>binary_sensor:
    - platform: mqtt
      name: "RF Switch 01"
      state_topic: "rainbow.lr/cmd/rfcode/F26A9C"
        </code></pre>
        <pre><code>automation:
    - id: '1588080407317'
      alias: RF Movies
      trigger:
      - payload: 'ON'
        platform: mqtt
        topic: rainbow.lr/cmd/rfcode/F26A9C
      condition: []
      action:
      - scene: scene.movies</code></pre>
      </section>

        <section>
            <h2>ESP Easy</h2>
            <h4>Przegląd projektów (Maciek)</h4>
            <ul>
                <li class="other-color">Sterowanie ogrzewaniem</li>
                <li class="other-color-2">Podlewanie ogrodu</li>
                <li class="other-color-3">Sterowanie bramą</li>
                <li class="other-color-4">Stacja pogodowa (szczegółowo)</li>
            </ul>
        </section>

        <section>
            <h3>Sterowanie ogrzewaniem</h3>
            <div class="r-hstack">
                <img src="img/devices/heat-rozdzielacz.png" alt="Heat">
                <img src="img/devices/heat-hass.png" alt="Hass">
            </div>
        </section>
        <section>
            <h3>Podlewanie ogrodu (1)</h3>
            <div class="r-hstack">
                <img src="img/devices/gardener-interior.jpg" alt="Gardener">
                <img src="img/devices/gardener-exterior.jpg" alt="Gardener">
            </div>
        </section>
        <section>
            <h3>Podlewanie ogrodu (2)</h3>
            <div class="r-hstack">
                <img src="img/devices/gardener-pipes.jpg" alt="Gardener">
                <img src="img/devices/gardener-wall.jpg" alt="Wall">
                <img src="img/devices/gardener-hass.png" alt="hass">
            </div>
        </section>
        <section>
            <h3>Sterowanie bramą</h3>
            <div class="r-hstack">
                <img src="img/devices/garage-interior.jpg" alt="Int">
                <img src="img/devices/garage-connected.jpg" alt="Conn">
                <img src="img/devices/garage-hass.png" alt="Hass">
            </div>
        </section>

        <section>
            <h3>Stacja pogodowa z zasilaniem bateryjnym</h3>
            <div class="r-hstack">
                <img src="img/devices/weather-outside.jpg" alt="Out">
                <img src="img/devices/weather-inside.jpg" alt="In">
            </div>
            <a href="https://github.com/maciejmalecki/weather">https://github.com/maciejmalecki/weather</a>
        </section>
        <section>
            <h3>Stacja pogodowa</h3>
            <ul>
                <li class="other-color">Pomiar temperatury, ciśnienia i wilgotności (BME 280),</li>
                <li class="other-color-2">komunikacja WiFi z użyciem ESP8266 i ESP Easy,</li>
                <li class="other-color-3">zasilanie bateryjne lub akumulatorowe,</li>
                <li class="other-color-3">niskie zużycie energii dzięki "deep sleep mode",</li>
                <li class="other-color-3">tryb konfiguracyjny,</li>
                <li class="other-color-4">pomiar napięcia zasilania,</li>
                <li class="other-color-4">regulacja i stabilizacja napięcia zasilania.</li>
            </ul>
        </section>
        <section>
            <h4>Podłączenie i konfiguracja czujnika BME 280</h4>
            <div class="r-hstack medium">
                <img src="img/devices/weather-esp.png" alt="esp">
                <img src="img/devices/weather-bme.png" alt="bme">
                <img src="img/devices/weather-pullups.png" alt="pullups">
            </div>
            <div class="r-hstack medium">
                <img src="img/devices/weather-esp-devices.png" alt="esp easy">
                <img src="img/devices/weather-bme-pic.png" alt="bme">
            </div>
        </section>
        <section>
            <h3>Zasilanie</h3>
            <div class="r-hstack">
                <img src="img/devices/weather-esp-ps.png" alt="esp">
                <img src="img/devices/weather-ps.png" alt="ps">
                <img src="img/devices/weather-ps-pic.jpg" alt="pic">
            </div>
        </section>
        <section>
            <h3>Kalibracja pomiaru napięcia</h3>
            <div class="r-hstack">
                <img src="img/devices/weather-vcc.png" alt="vcc">
            </div>
        </section>
        <section>
            <h3>Reguły ESP Easy</h3>
            <div class="r-hstack">
                <img src="img/devices/weather-settings.png" alt="Settings">
                <img src="img/devices/weather-rules.png" alt="Rules">
            </div>
        </section>
        <section>
            <h3>Publikacja danych i uśpienie</h3>
            <div class="r-hstack">
                <pre>
                    <code data-line-numbers data-trim data-noescape style="font-size: 0.8em;">
                        on MQTT#Connected do
                          AsyncEvent,evtPublish
                        endon
                        on MQTT#Disconnected do
                          AsyncEvent,evtNext
                        endon
                        on evtPublish do
                          Publish,%sysname%/vcc,[vcc#vcc]
                          Publish,%sysname%/temp,[weather#temp]
                          Publish,%sysname%/hum,[weather#hum]
                          Publish,%sysname%/press,[weather#press]
                          AsyncEvent,evtNext
                        endon
                    </code>
                </pre>
                <pre>
                    <code data-line-numbers data-trim data-noescape style="font-size: 0.8em;">
                        on evtNext do
                          if [dummy#mode]=0
                            DeepSleep,900
                          else
                            TimerSet,1,60
                          endif
                        endon



                        on Rules#Timer=1 do
                          AsyncEvent,evtPublish
                        endon
                    </code>
                </pre>
            </div>
        </section>
        <section>
            <h4>Konfiguracja po stronie HomeAssistant (fragment)</h4>
            <pre><code data-trim data-noescape>
                sensor:
                 - platform: mqtt
                   state_topic: Weather_1/temp
                   name: "weather-1-temp"
                   device_class: "temperature"
                   unit_of_measurement: "°C"
                 - platform: mqtt
                   state_topic: Weather_1/hum
                   name: "weather-1-hum"
                   device_class: "humidity"
                   unit_of_measurement: "%"
            </code></pre>
        </section>
        <section>
            <h3>Wizualizacja (Lovelace)</h3>
            <div class="r-hstack">
                <img src="img/esp-easy/weather-hass.png" alt="hass">
            </div>
        </section>
        <section>
            <h3>Tryb konfiguracji</h3>
            <div class="r-hstack">
                <img src="img/devices/weather-buttons.png" alt="Mode">
                <img src="img/devices/weather-mode.png" alt="Mode">
                <img src="img/devices/weather-dummy.png" alt="Dummy">
            </div>
        </section>
        <section>
            <h3>Tryb konfiguracji</h3>
            <div class="r-hstack">
                <pre>
                    <code data-line-numbers data-trim data-noescape style="font-size: 0.8em;">
                        on System#Boot do AsyncEvent,evtStart endon
                        on System#Wake do AsyncEvent,evtStart endon
                        on Rules#Timer=2 do
                          TaskValueSet,3,1,[Plugin#GPIO#Pinstate#14]
                          TimerSet,4,600
                        endon
                        on Rules#Timer=3 do
                          AsyncEvent,evtNext
                        endon
                        on Rules#Timer=4 do
                          DeepSleep,900
                        endif
                    </code>
                </pre>
                <pre>
                    <code data-line-numbers data-trim data-noescape style="font-size: 0.8em;">
                        on evtStart do
                          TaskValueSet,3,1,1
                          if [Plugin#GPIO#Pinstate#14]=1
                            TimerSet,2,1
                          else
                            if [vcc#vcc]<3.20
                              DeepSleep,4294
                            endif
                            TaskValueSet,3,1,0
                          endif
                          TimerSet,3,30
                        endon
                    </code>
                </pre>
                </div>
        </section>
        <section>
            <h3>Obwód wybudzania</h3>
            <div class="r-hstack">
                <img src="img/devices/weather-esp.png" alt="esp">
                <img src="img/devices/weather-reset.png" alt="reset">
            </div>
        </section>
        <section>
            <h3>Powiadomienia (Slack)</h3>
            <pre><code data-trim data-noescape>
                notify:
                  - name: 'slacknotifier'
                    platform: slack
                    api_key: !secret slack_api_key
                    default_channel: '#general'
            </code></pre>
        </section>
        <section>
            <h3>Automatyzacja Home Assistant</h3>
            <p>Wysłanie powiadomienia przez Slack</p>
            <pre><code data-trim data-noescape>
                automation:
                 - alias: "Notify on overhumid"
                   trigger:
                     platform: numeric_state
                     entity_id: sensor.weather_1_hum
                     above: 50
                   action:
                     - service: notify.slacknotifier
                       data_template:
                         message: "Wilgotność w łazience: {{ states('sensor.weather_1_hum') }}%"
            </code></pre>
        </section>
        <section>
            <h3>Slack</h3>
            <div class="r-hstack">
                <img src="img/devices/slack.png" alt="Slack">
            </div>
        </section>

        <section>
            <h3>Wizualizacja - wykresy</h3>
            <div class="r-hstack">
                <img src="img/hass-plots.png" alt="Plots">
                <img src="img/hass-plots-2.png" alt="Plots2">
            </div>
        </section>

        <section>
            <h3>Akwizycja i wizualizacja danych - InfluxDB</h3>
            <pre><code data-trim data-noescape>
                influxdb:
                  api_version: 2
                  ssl: true
                  host: eu-central-1-1.aws.cloud2.influxdata.com
                  token: !secret influxdb_token
                  organization: !secret influxdb_org
                  bucket: homeassistant
                  include:
                    entity_globs:
                      - sensor.weather_*
                      - sensor.temp_wody
                      - sensor.garden_*
                      - sensor.garage_*
            </code></pre>
        </section>
        <section data-background-image="img/influx-db.png" data-background-size="95%">
        </section>

        <section>
            <h3>Q&A</h3>
            <img src="img/qrcode2.png" alt="qr2">
            <p>
                <a href="https://wania.github.io/ESP8266-InPractice/part-2.html">https://wania.github.io/ESP8266-InPractice/part-2.html</a>
            </p>
        </section>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
        // More info about initialization & config:
        // - https://revealjs.com/initialization/
        // - https://revealjs.com/config/
        Reveal.initialize({
            hash: true,
            history: true,
            slideNumber: true,
            width: '80%',

            // Learn about plugins: https://revealjs.com/plugins/
            plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
        });
    </script>
</div>
</body>
</html>
